function calcGroupDelay(a,t){if(a.length<2)return[[],[]];t=unwrapPhase(t);for(var e=[],s=[],i=1;i<a.length;i++){var h=2*(a[i]-a[i-1])*Math.PI,r=(a[i-1]+a[i])/2;e.push(r);var l=-1e3*((t[i]-t[i-1])/180*Math.PI)/h;s.push(l)}return[e,s]}function fft(a){var t=a.length;if(t<=1)return a;var e=fft(a.filter(((a,t)=>t%2==0))),s=fft(a.filter(((a,t)=>t%2!=0))),i=new Array(t).fill(null).map((()=>Complex(0,0)));for(let a=0;a<t/2;a++){var h=Complex(Math.cos(-2*Math.PI*a/t),Math.sin(-2*Math.PI*a/t)).mul(s[a]);i[a]=h.add(e[a]),i[a+t/2]=h.sub(e[a])}return i}function logSpace(){var a="filters"===V.tab?1:10,t=.95*DEV.samplerate/2,e=Math.log10(a),s=(Math.log10(t)-e)/1e3;return Array.from({length:1e3},((a,t)=>10**(e+t*s)))}function unwrapPhase(a,t=150){var e=0,s=0,i=new Array(a.length).fill(0);if(a.length>0){i[0]=a[0];for(var h=1;h<a.length;h++){var r=a[h-1]+s,l=a[h]-r,n=!1;l>t?(e-=1,n=!0):l<-t&&(e+=1,n=!0),i[h]=a[h]+360*e,n||(s=i[h]-i[h-1])}}return i}class BaseFilter{constructor(){}complexGain(a,t=!1){return[a,new Array(a.length).fill(1)]}gainAndPhase(a,t=!1,e){var[s,i]=this.complexGain(a,t),h=i.map((a=>isFinite(a.re)?20*Math.log10(a.abs()+1e-15):0)),r=i.map((a=>180*Math.atan2(a.im,a.re)/Math.PI)),[l,n]=calcGroupDelay(a,r);e(h,r,l,n)}}class Biquad extends BaseFilter{constructor(a,t){var e,s,i,h,r,l;switch(super(),a.type){case"Allpass":var n=a.freq,p=2*Math.PI*n/t,o=Math.sin(p),f=Math.cos(p);h=1-(ya="q"in a?o/(2*a.q):o*Math.sinh(Math.log(2)/2*a.bandwidth*p/o)),r=-2*f,l=1+ya,e=1+ya,s=-2*f,i=1-ya;break;case"AllpassFO":n=a.freq,p=2*Math.PI*n/t;var u=Math.tan(p/2);h=1,r=ya=(u+1)/(u-1),l=0,e=ya,s=1,i=0;break;case"Bandpass":n=a.freq,p=2*Math.PI*n/t,o=Math.sin(p),f=Math.cos(p);h=ya="q"in a?o/(2*a.q):o*Math.sinh(Math.log(2)/2*a.bandwidth*p/o),r=0,l=-ya,e=1+ya,s=-2*f,i=1-ya;break;case"Free":e=1,s=a.a1,i=a.a2,h=a.b0,r=a.b1,l=a.b2;break;case"GeneralNotch":var c=a.freq_pole,M=a.freq_zero,m=a.q_pole,d=!0===a.normalize_at_dc,g=Math.tan(Math.PI*M/t),q=Math.tan(Math.PI*c/t),w=q**2,v=g**2,b=d?w/v:1;h=b*(1+v),r=-2*b*(1-v),l=b*(1+v),e=1+(ya=q/m)+w,s=2*w-2,i=1-ya+w;break;case"Highpass":var y=a.freq,P=a.q,I=2*Math.PI*y/t,x=Math.sin(I),k=Math.cos(I),B=x/(2*P);h=(1+k)/2,r=-(1+k),l=(1+k)/2,e=1+B,s=-2*k,i=1-B;break;case"HighpassFO":n=a.freq,p=2*Math.PI*n/t;e=1,s=-(1-(ra=Math.tan(p/2)))/(ya=1+ra),i=0,h=1/ya,r=-1/ya,l=0;break;case"Highshelf":var F,G,L=a.freq,A=a.gain,_=2*Math.PI*L/t,S=Math.pow(10,A/40),H=Math.sin(_),O=Math.cos(_);if("slope"in a){var C=a.slope;F=H/2*Math.sqrt((S+1/S)*(1/(C/12)-1)+2),G=2*Math.sqrt(S)*F}else{var z=a.q;G=H*Math.sqrt(S)/z}h=S*(S+1+(S-1)*O+G),r=-2*S*(S-1+(S+1)*O),l=S*(S+1+(S-1)*O-G),e=S+1-(S-1)*O+G,s=2*(S-1-(S+1)*O),i=S+1-(S-1)*O-G;break;case"HighshelfFO":var E=a.freq,D=a.gain,Q=2*Math.PI*E/t,R=Math.pow(10,D/40),N=Math.tan(Q/2);h=R*N+Math.pow(R,2),r=R*N-Math.pow(R,2),l=0,e=R*N+1,s=R*N-1,i=0;break;case"LinkwitzTransform":var T=a.freq_act,V=a.q_act,j=a.q_target,J=a.freq_target,U=Math.pow(2*Math.PI*T,2),$=2*Math.PI*T/V,K=Math.pow(2*Math.PI*J,2),W=2*Math.PI*J/j,X=(J+T)/2,Y=2*Math.PI*X/Math.tan(Math.PI*X/t),Z=K+Y*W+Math.pow(Y,2);h=(U+Y*$+Math.pow(Y,2))/Z,r=2*(U-Math.pow(Y,2))/Z,l=(U-Y*$+Math.pow(Y,2))/Z,e=1,s=2*(K-Math.pow(Y,2))/Z,i=(K-Y*W+Math.pow(Y,2))/Z;break;case"Lowpass":var aa=a.freq,ta=a.q,ea=2*Math.PI*aa/t,sa=Math.sin(ea),ia=Math.cos(ea),ha=sa/(2*ta);h=(1-ia)/2,r=1-ia,l=(1-ia)/2,e=1+ha,s=-2*ia,i=1-ha;break;case"LowpassFO":var ra;n=a.freq,p=2*Math.PI*n/t;e=1,s=-(1-(ra=Math.tan(p/2)))/(ya=1+ra),i=0,h=ra/ya,r=ra/ya,l=0;break;case"Lowshelf":var la,na,pa=a.freq,oa=a.gain,fa=2*Math.PI*pa/t,ua=Math.pow(10,oa/40),ca=Math.sin(fa),Ma=Math.cos(fa);if("slope"in a){var ma=a.slope;la=ca/2*Math.sqrt((ua+1/ua)*(1/(ma/12)-1)+2),na=2*Math.sqrt(ua)*la}else{var da=a.q;na=ca*Math.sqrt(ua)/da}h=ua*(ua+1-(ua-1)*Ma+na),r=2*ua*(ua-1-(ua+1)*Ma),l=ua*(ua+1-(ua-1)*Ma-na),e=ua+1+(ua-1)*Ma+na,s=-2*(ua-1+(ua+1)*Ma),i=ua+1+(ua-1)*Ma-na;break;case"LowshelfFO":var ga=a.freq,qa=a.gain,wa=2*Math.PI*ga/t,va=Math.pow(10,qa/40),ba=Math.tan(wa/2);h=Math.pow(va,2)*ba+va,r=Math.pow(va,2)*ba-va,l=0,e=ba+va,s=ba-va,i=0;break;case"Notch":var ya;n=a.freq,p=2*Math.PI*n/t,o=Math.sin(p);h=1,r=-2*(f=Math.cos(p)),l=1,e=1+(ya="q"in a?o/(2*a.q):o*Math.sinh(Math.log(2)/2*a.bandwidth*p/o)),s=-2*f,i=1-ya;break;case"Peaking":var Pa,Ia=a.freq,xa=a.gain,ka=2*Math.PI*Ia/t,Ba=Math.sin(ka),Fa=Math.cos(ka),Ga=Math.pow(10,xa/40);if("q"in a){Pa=Ba/(2*a.q)}else{var La=a.bandwidth;Pa=Ba*Math.sinh(Math.log(2)/2*La*ka/Ba)}h=1+Pa*Ga,r=-2*Fa,l=1-Pa*Ga,e=1+Pa/Ga,s=-2*Fa,i=1-Pa/Ga}this.fs=t,this.a1=s/e,this.a2=i/e,this.b0=h/e,this.b1=r/e,this.b2=l/e}complexGain(a,t=!1){for(var e,s,i,h,r,l=a.length,n=[],p=0;p<l;p++)h=(i=Complex(0,1).mul(2*Math.PI*a[p]/this.fs).exp()).pow(-1),r=i.pow(-2),s=h.mul(this.b1).add(this.b0).add(r.mul(this.b2)),e=h.mul(this.a1).add(1).add(r.mul(this.a2)),n.push(s.div(e));return[a,n]}}class BiquadCombo extends BaseFilter{ButterwQ(a){for(var t=a%2>0,e=Math.floor(a/2),s=[],i=0;i<e;i++){var h=1/(2*Math.sin(Math.PI/a*(i+.5)));s.push(h)}return t&&s.push(-1),s}constructor(a,t){switch(super(),this.ftype=a.type,this.ftype){case"ButterworthHighpass":case"ButterworthLowpass":case"LinkwitzRileyHighpass":case"LinkwitzRileyLowpass":var e;if(this.order=a.order,this.freq=a.freq,this.fs=t,this.typeSO=this.ftype.includes("Hi")?"Highpass":"Lowpass",this.typeFO=this.typeSO+"FO","LinkwitzRileyHighpass"===this.ftype){var s=this.ButterwQ(this.order/2);e=this.order/2%2>0?s.slice(0,-1).concat(s).concat([.5]):s.concat(s)}else if("LinkwitzRileyLowpass"===this.ftype){s=this.ButterwQ(this.order/2);e=this.order/2%2>0?s.slice(0,-1).concat(s).concat([.5]):s.concat(s)}else("ButterworthHighpass"===this.ftype||"ButterworthLowpass"===this.ftype)&&(e=this.ButterwQ(this.order));this.biquads=e.map((a=>new Biquad(a>=0?{freq:this.freq,q:a,type:this.typeSO}:{freq:this.freq,type:this.typeFO},this.fs)));break;case"FivePointPeq":this.biquads=[new Biquad({freq:a.fls,q:a.qls,gain:a.gls,type:"Lowshelf"},t),new Biquad({freq:a.fp1,q:a.qp1,gain:a.gp1,type:"Peaking"},t),new Biquad({freq:a.fp2,q:a.qp2,gain:a.gp2,type:"Peaking"},t),new Biquad({freq:a.fp3,q:a.qp3,gain:a.gp3,type:"Peaking"},t),new Biquad({freq:a.fhs,q:a.qhs,gain:a.ghs,type:"Highshelf"},t)];break;case"GraphicEqualizer":var i=a.gains.length,h=a.freq_min||20,r=a.freq_max||2e4,l=Math.log2(h),n=(Math.log2(r)-l)/i;this.biquads=a.gains.map(((a,e)=>{var s=l+(e+.5)*n,i=Math.pow(2,s);return new Biquad({freq:i,bandwidth:n,gain:a,type:"Peaking"},t)}));break;case"Tilt":var p=-a.gain/2,o=a.gain/2;this.biquads=[new Biquad({freq:110,q:.35,gain:p,type:"Lowshelf"},t),new Biquad({freq:3500,q:.35,gain:o,type:"Highshelf"},t)]}}complexGain(a,t=!1){var e=new Array(a.length).fill(1);return this.biquads.forEach((t=>{var[s,i]=t.complexGain(a);e=e.map(((a,t)=>i[t].mul(a)))})),[a,e]}}class Conv{constructor(a,t){a||(a={values:[1]}),this.conf=a,this.fs=t}findPeak(){for(var a=Math.abs(this.impulse[0]),t=0,e=1;e<this.impulse.length;e++){var s=Math.abs(this.impulse[e]);s>a&&(a=s,t=e)}return t}complexGain(a,t=!1){var e=this.impulse.length,s=Math.pow(2,Math.ceil(Math.log2(e)));s<1024&&(s=1024);var h=this.impulse.slice(),r=new Array(s-e).fill(0),l=fft(h=h.concat(r)),n=Array.from({length:s/2},((a,t)=>this.fs*t/s)),p=l.slice(0,s/2);if(t){var o=this.findPeak(),f=p.length,u=[];for(i=0;i<f;i++)u.push(Complex(0,1).neg().mul(Math.PI*i*o/(s/2)).exp().mul(p[i]))}return null!==a?[a,this.interpolatePolar(u,n,a)]:[n,t?u:p]}interpolate(a,t,e){var s=[];for(var i of e){var h=a.length*i/t[t.length-1],r=Math.floor(h),l=r+1;r>=a.length&&(r=a.length-1),l>=a.length&&(l=r);var n=h-r,p=(1-n)*a[r]+n*a[l];s.push(p)}return s}interpolatePolar(a,t,e){var s=a.map((a=>a.abs())),i=a.map((a=>180*Math.atan2(a.im,a.re)/Math.PI));i=unwrapPhase(i,270).map((a=>Math.PI*a/180));var h=this.interpolate(s,t,e),r=this.interpolate(i,t,e);return h.map(((a,t)=>Complex({r:a,phi:r[t]})))}gainAndPhase(a,t=!1,e){bash("camilla-audiofileread.py '"+JSON.stringify(this.conf)+"'",(s=>{this.impulse=s;var[i,h]=this.complexGain(null,t),r=(h=this.interpolatePolar(h,i,a)).map((a=>isFinite(a.re)?20*Math.log10(a.abs()+1e-15):0)),l=h.map((a=>180*Math.atan2(a.im,a.re)/Math.PI)),[n,p]=calcGroupDelay(a,l);e(r,l,n,p)}),"json")}getImpulse(){return[Array.from({length:this.impulse.length},((a,t)=>t/this.fs)),this.impulse]}}class Delay extends BaseFilter{constructor(a,t){super(),this.fs=t;var e=a.unit||"ms";if(null===e&&(e="ms"),"ms"===e)this.delaySamples=a.delay/1e3*t;else if("mm"===e)this.delaySamples=a.delay/1e3*t/343;else{if("samples"!==e)throw new Error(`Unknown unit ${e}`);this.delaySamples=a.delay}this.subsample=!0===a.subsample,this.subsample?(this.delayFullSamples=Math.floor(this.delaySamples),this.fraction=this.delaySamples-this.delayFullSamples,this.a1=1-this.fraction,this.a2=0,this.b0=1-this.fraction,this.b1=1,this.b2=0):this.delayFullSamples=Math.round(this.delaySamples)}complexGain(a,t=!1){var e,s,h,r,l,n=a.map((a=>{Complex(0,1).mul(2*Math.PI*a/this.fs).exp()}));this.subsample?e=n.map((t=>{t=Complex(0,1).mul(2*Math.PI*a[i]/this.fs).exp(),r=t.pow(-1),l=t.pow(-2),h=r.mul(this.b1).add(this.b0).add(l.mul(this.b2)),s=r.mul(this.a1).add(1).add(l.mul(this.a2)),h.div(s)})):e=new Array(n.length).fill(1);if(!t){var p=this.delayFullSamples/this.fs;e=e.map(((t,e)=>{Complex(0,1).mul(2*Math.PI*a[e]*p).exp().mul(t)}))}return[a,e]}}class DiffEq extends BaseFilter{constructor(a,t){super(),this.fs=t,this.a=a.a,this.b=a.b,0===this.a.length&&(this.a=[1]),0===this.b.length&&(this.b=[1])}complex_gain(a,t=!1){var e=a.map((a=>{Complex(0,1).mul(2*Math.PI*a/this.fs).exp()})),s=new Array(a.length).fill(0);this.b.forEach(((a,t)=>{s=s.map(((s,i)=>{e[i].pow(-t).mul(a).add(s)}))}));var i=new Array(a.length).fill(0);return this.a.forEach(((a,t)=>{i=i.map(((s,i)=>{e[i].pow(-t).mul(a).add(s)}))})),[a,s.map(((a,t)=>a.div(i[t])))]}}class Gain extends BaseFilter{constructor(a){super(),this.gain=a.gain,this.inverted=!0===a.inverted,this.scale=a.scale||"dB"}complexGain(a,t=!1){var e,s=this.inverted?-1:1;return e="dB"===this.scale?Math.pow(10,this.gain/20)*s:this.gain*s,[a,new Array(a.length).fill(e)]}}class Loudness extends BaseFilter{constructor(a,t,e){super();var s=-(e-a.reference_level)/20,i=(s=Math.max(0,Math.min(1,s)))*a.high_boost,h=s*a.low_boost;if(a.attenuate_mid){var r=Math.max(i,h);this.midGain=Math.pow(10,-r/20)}else this.midGain=1;var l=new Biquad({freq:70,slope:12,gain:h,type:"Lowshelf"},t),n=new Biquad({freq:3500,slope:12,gain:i,type:"Highshelf"},t);this.biquads=[l,n]}complexGain(a,t=!1){var e=new Array(a.length).fill(this.midGain);return this.biquads.forEach((t=>{var[s,i]=t.complexGain(a);e=e.map(((a,t)=>i[t].mul(a)))})),[a,e]}}
