/**
 * @category  html5 widgets
 * @package   Kelly
 * @author    Rubchuk Vladimir <torrenttvi@gmail.com>
 * @copyright 2015-2022 Rubchuk Vladimir
 * @license   GPLv3
 * @version   1.22
 *
 * Usage example :
 *
 *   new KellyColorPicker({place : 'color-picker'});
 *
 * ToDo :
 * 
 * Add switch color in colorsavers button (analog of X button in Photoshop)
 * updateConfig method
 *
 **/ /**
 * Create color picker
 * @param {Array} cfg
 * @returns {KellyColorPicker}
 */ function KellyColorPicker(f){var h,i,j,k,l,m=Math.PI,n=!0,g=new Object;g.radius=4;var o=!1,p=!1,q="quad",r=!1,s=!1,t=!0,u=new Array,v=new Array,w=document.createElement("canvas"),x=!1,y=!1,z=null,A=!1,B=!0,C="mixed",e=new Object;e.tag=!1,e.margin=6;var D=!1,E=this,F=200,G="#000000",H=1,I=!1,J=!1,K=new Array,L=!1,M=new Array;function N(c,b,d){b=!!b;var a=new Object;a.width,a.widthPercentage=22,a.imageData=null,a.align=c,a.selected=b,a.color="#ffffff",a.position,a.paddingY=-4,a.paddingX=4,a.lineWidth=1,a.selectSize=4,"right"==c&&(a.paddingX=-1*a.paddingX),a.selected&&(a.color=G),d&&(a.color=d),a.updateSize=function(){this.width=parseInt(F-F/100*(100-this.widthPercentage)),"left"==this.align?this.position={x:0,y:F-this.width}:"right"==this.align&&(this.position={x:F-this.width,y:F-this.width})},a.calcS=function(a){return Math.abs((a[1].x-a[0].x)*(a[2].y-a[0].y)-(a[2].x-a[0].x)*(a[1].y-a[0].y))/2},a.isDotIn=function(e){var a=new Array;"left"==this.align?(a[0]={x:this.position.x,y:this.position.y},a[1]={x:this.position.x,y:this.position.y+this.width},a[2]={x:this.position.x+this.width,y:this.position.y+this.width}):(a[0]={x:this.position.x+this.width,y:this.position.y},a[1]={x:a[0].x,y:a[0].y+this.width},a[2]={x:a[0].x-this.width,y:this.position.y+this.width});for(var c=0;c<=a.length-1;++c)a[c].x+=this.paddingX,a[c].y+=this.paddingY;var f=this.calcS(a),b=[{x:a[0].x,y:a[0].y},{x:a[1].x,y:a[1].y},{x:e.x,y:e.y}],d=this.calcS(b);return b[1]={x:a[2].x,y:a[2].y},d+=this.calcS(b),b[0]={x:a[1].x,y:a[1].y},d+=this.calcS(b),Math.ceil(d)==Math.ceil(f)},a.draw=function(){w.width=this.width,w.height=this.width,x.clearRect(0,0,this.width,this.width),x.beginPath(),"left"==this.align&&(x.moveTo(this.lineWidth/2,this.width-this.lineWidth),x.lineTo(this.width,this.width-this.lineWidth),x.lineTo(this.lineWidth,this.lineWidth),x.lineTo(this.lineWidth,this.width-this.lineWidth)),"right"==this.align&&(x.moveTo(this.lineWidth/2,this.width-this.lineWidth),x.lineTo(this.width-this.lineWidth,this.width-this.lineWidth),x.lineTo(this.width-this.lineWidth,this.lineWidth),x.lineTo(this.lineWidth,this.width-this.lineWidth)),this.selected&&(x.fillStyle="rgba(255,255,255, 1)",x.fill(),x.strokeStyle="rgba(0, 0, 0, 1)",x.stroke(),x.closePath(),x.beginPath(),x.lineWidth=this.lineWidth,"left"==this.align&&(x.moveTo(this.selectSize,this.width-this.selectSize),x.lineTo(this.width-2*this.selectSize,this.width-this.selectSize),x.lineTo(this.selectSize,2*this.selectSize),x.lineTo(this.selectSize,this.width-this.selectSize)),"right"==this.align&&(x.moveTo(2*this.selectSize,this.width-this.selectSize),x.lineTo(this.width-this.selectSize,this.width-this.selectSize),x.lineTo(this.width-this.selectSize,2*this.selectSize),x.lineTo(2*this.selectSize,this.width-this.selectSize)));var a=W(this.color);x.fillStyle="rgba("+a.r+","+a.g+","+a.b+", 1)",x.fill(),x.strokeStyle="rgba(0, 0, 0, 1)",x.stroke(),this.imageData=x.getImageData(0,0,this.width,this.width),p.drawImage(w,this.position.x+this.paddingX,this.position.y+this.paddingY)};var e=K.length;K[e]=a}var b=new Object;b.width=18,b.imageData=null,b.innerRadius,b.startAngle=0,b.outerRadius,b.outerStrokeStyle="rgba(0,0,0,0.2)",b.innerStrokeStyle="rgba(0,0,0,0.2)",b.pos,b.draw=function(){if(this.imageData)w.width=F,w.height=F,x.putImageData(this.imageData,0,0),p.drawImage(w,0,0);else{for(var b=this.startAngle,a=0;a<=360;a++){var d=Y(a-2),e=Y(a);p.beginPath(),p.moveTo(j,j),p.arc(j,j,this.outerRadius,d,e,!1),p.closePath();var c=U(b/360,1,1);p.fillStyle="rgb("+c.r+", "+c.g+", "+c.b+")",p.fill(),++b>=360&&(b=0)}p.globalCompositeOperation="destination-out",p.beginPath(),p.arc(j,j,this.innerRadius,0,2*m),p.fill(),p.globalCompositeOperation="source-over",p.strokeStyle=this.innerStrokeStyle,p.lineWidth=2,p.stroke(),p.closePath(),p.beginPath(),p.arc(j,j,this.outerRadius,0,2*m),p.strokeStyle=this.outerStrokeStyle,p.lineWidth=2,p.stroke(),p.closePath(),this.imageData=p.getImageData(0,0,F,F)}},b.isDotIn=function(a){return!!(Math.pow(this.pos.x-a.x,2)+Math.pow(this.pos.y-a.y,2)<Math.pow(this.outerRadius,2)&&Math.pow(this.pos.x-a.x,2)+Math.pow(this.pos.y-a.y,2)>Math.pow(this.innerRadius,2))};var d=new Object;d.lineWeight=2,d.height=4,d.paddingX=2,d.path;var a=new Object;a.width=18,a.padding=4,a.outerStrokeStyle="rgba(0,0,0,0.2)",a.innerStrokeStyle="rgba(0,0,0,0.2)",a.height,a.pos,a.updateSize=function(){this.pos={x:F+a.padding,y:a.padding},this.height=F-2*a.padding},a.draw=function(){var b=p.createLinearGradient(0,0,0,this.height),a=U(k.h,1,1);b.addColorStop(0,"rgba("+a.r+","+a.g+","+a.b+",1)"),b.addColorStop(1,"rgba("+a.r+","+a.g+","+a.b+",0)"),p.beginPath(),p.rect(this.pos.x,this.pos.y,this.width,this.height),p.fillStyle="white",p.fill(),p.fillStyle=b,p.fill(),p.strokeStyle="rgba(0,0,0, 0.2)",p.lineWidth=2,p.stroke(),p.closePath()},a.dotToAlpha=function(a){return 1-Math.abs(this.pos.y-a.y)/this.height},a.alphaToDot=function(a){return{x:0,y:this.height-this.height*a}},a.limitDotPosition=function(b){var a=b.y;return a<this.pos.y&&(a=this.pos.y),a>this.pos.y+this.height&&(a=this.pos.y+this.height),{x:this.pos.x,y:a}},a.isDotIn=function(b){return!(b.x<this.pos.x)&&!(b.x>this.pos.x+a.width)&&!(b.y<this.pos.y)&&!(b.y>this.pos.y+this.height)};var c=new Object;function O(d){var b=d.getBoundingClientRect(),c=0,e=0;return r&&(e=a.width+2*a.padding),d===o?b.width<=b.height?c=b.height:b.height<b.width&&(c=b.width):J?"height"==J?c=b.height:"width"==J&&(c=b.width):b.width>b.height?c=b.height:b.height>=b.width&&(c=b.width),c=parseInt(c),r&&(c-=e),!(c<=0)&&c}function P(a,i){var c=1,b=!1;if("string"==typeof a){if(-1==(a=a.trim(a)).indexOf("(")){if("#"==a.charAt(0)&&(a=a.slice(1)),(a=a.substr(0,8)).length>=3){if(a.length>6&&a.length<8&&(a=a.substr(0,6)),a.length>3&&a.length<6&&(a=a.substr(0,3)),b=a,a.length>=3&&a.length<=4){b="";for(let d=0;d<a.length;d++)b+=a[d]+a[d]}8==b.length&&(c=(255&parseInt(b,16))/255)}}else if((vals=a.split(",")).length>=3){switch(a.substring(0,3)){case"rgb":vals[0]=vals[0].replace("rgba(",""),vals[0]=vals[0].replace("rgb(","");var e={r:parseInt(vals[0]),g:parseInt(vals[1]),b:parseInt(vals[2])};e.r<=255&&e.g<=255&&e.b<=255&&(b=X(e));break;case"hsl":vals[0]=vals[0].replace("hsl(",""),vals[0]=vals[0].replace("hsla(","");var f=parseFloat(vals[0])/360,g=parseFloat(vals[1])/100,h=parseFloat(vals[2])/100;f>=0&&g<=1&&h<=1&&(b=X(U(f,g,h)))}4==vals.length&&((c=parseFloat(vals[3]))&&!(c<0)||(c=0),c>1&&(c=1))}}else"object"==typeof a&&(void 0!==a.r&& void 0!==a.g&& void 0!==a.b?b=X(a):void 0!==a.h&& void 0!==a.s&& void 0!==a.l&&(a.h=parseFloat(a.h)/360,a.s=parseFloat(a.s)/100,a.l=parseFloat(a.l)/100,a.h>=0&&a.s<=1&&a.l<=1&&(b=X(U(a.h,a.s,a.l)))),void 0!==a.a&&(c=a.a));return(!1!==b||!i)&&(!1===b&&(b="000000"),{h:b="#"!=b.charAt(0)?"#"+(b=b.substr(0,6)):b.substr(0,7),a:c})}function Q(){if(M.quad)return M.quad;var a=new Object;return a.size,a.padding=2,a.path,a.imageData=null,a.dotToSv=function(a){return{s:Math.abs(this.path[3].x-a.x)/this.size,v:Math.abs(this.path[3].y-a.y)/this.size}},a.svToDot=function(d){var g=this.path[0].x,h=this.path[0].y,a=.02;F<150?a=.07:F<100&&(a=.16);for(var b=0;b<this.size;b++)for(var c=0;c<this.size;c++){var e={x:c+g,y:b+h},f=this.dotToSv(e),i=Math.abs(f.s-d.s),j=Math.abs(f.v-d.v);if(i<a&&j<a)return e}return{x:0,y:0}},a.limitDotPosition=function(c){var a=c.x,b=c.y;return a<this.path[0].x&&(a=this.path[0].x),a>this.path[0].x+this.size&&(a=this.path[0].x+this.size),b<this.path[0].y&&(b=this.path[0].y),b>this.path[0].y+this.size&&(b=this.path[0].y+this.size),{x:a,y:b}},a.draw=function(){this.imageData||(this.imageData=p.createImageData(this.size,this.size));for(var a=0,e=this.path[0].x,f=this.path[0].y,b=0;b<this.size;b++)for(var c=0;c<this.size;c++){var h={x:c+e,y:b+f},g=this.dotToSv(h),d=U(k.h,g.s,g.v);this.imageData.data[a+0]=d.r,this.imageData.data[a+1]=d.g,this.imageData.data[a+2]=d.b,this.imageData.data[a+3]=255,a+=4}p.putImageData(this.imageData,e,f),p.beginPath(),p.strokeStyle="rgba(0,0,0, 0.2)",p.lineWidth=2;for(var a=0;a<=this.path.length-1;++a)0==a?p.moveTo(this.path[a].x,this.path[a].y):p.lineTo(this.path[a].x,this.path[a].y);p.stroke(),p.closePath()},a.updateSize=function(){var c=2*b.innerRadius-2*d.paddingX-2*this.padding;this.size=Math.floor(c/Math.sqrt(2)),this.path=new Array,this.path[0]={x:-1*(this.size/2),y:-1*(this.size/2)},this.path[1]={x:this.path[0].x+this.size,y:this.path[0].y},this.path[2]={x:this.path[1].x,y:this.path[1].y+this.size},this.path[3]={x:this.path[2].x-this.size,y:this.path[2].y},this.path[4]={x:this.path[0].x,y:this.path[0].y};for(var a=0;a<=this.path.length-1;++a)this.path[a].x+=b.pos.x,this.path[a].y+=b.pos.y},a.isDotIn=function(a){return!(a.x<this.path[0].x)&&!(a.x>this.path[0].x+this.size)&&!(a.y<this.path[0].y)&&!(a.y>this.path[0].y+this.size)},M.quad=a,a}function R(){if(M.triangle)return M.triangle;var a=new Object;return a.size,a.padding=2,a.path,a.imageData=null,a.followWheel=!0,a.s,a.sOnTop=!1,a.outerRadius,a.limitDotPosition=function(e){var f=e.x,g=e.y,i=this.path[0].x,h=this.path[2].x,a=f,c=g;a=Math.min(Math.max(h,a),i);var d=(this.path[0].y-this.path[1].y)/(this.path[0].x-this.path[1].x),j=Math.ceil(this.path[1].y+d*(a-this.path[1].x));d=(this.path[0].y-this.path[2].y)/(this.path[0].x-this.path[2].x);var k=Math.floor(this.path[2].y+d*(a-this.path[2].x));return f<h&&(b.pos.y,b.pos.x,c=g),c=Math.min(Math.max(j,c),k),{x:a,y:c}},a.svToDot=function(e){var a=.02;F<150?a=.07:F<100&&(a=.16);for(var b=0;b<this.size;b++)for(var c=0;c<this.size;c++){var d={x:this.path[1].x+c,y:this.path[1].y+b};if(h.isDotIn(d)){var f=this.dotToSv(d),g=Math.abs(f.s-e.s),i=Math.abs(f.v-e.v);if(g<a&&i<a)return d}}return{x:0,y:0}},a.draw=function(){this.imageData||(this.imageData=x.createImageData(this.size,this.size)),w.width=this.size,w.height=this.size;for(var i=this.path[1].x,j=this.path[1].y,a=0,c=0;c<this.size;c++)for(var d=0;d<this.size;d++){var f={x:this.path[1].x+d,y:this.path[1].y+c};if(h.isDotIn(f)){var g=this.dotToSv(f),e=U(k.h,g.s,g.v);this.imageData.data[a+0]=e.r,this.imageData.data[a+1]=e.g,this.imageData.data[a+2]=e.b,this.imageData.data[a+3]=255}else this.imageData.data[a+0]=0,this.imageData.data[a+1]=0,this.imageData.data[a+2]=0,this.imageData.data[a+3]=0;a+=4}x.putImageData(this.imageData,0,0),p.drawImage(w,i,j),p.beginPath(),p.strokeStyle="rgba(0, 0, 0, 0.3)",p.lineWidth=2;for(var b=this.path,a=0;a<=b.length-1;++a)0==a?p.moveTo(b[a].x,b[a].y):p.lineTo(b[a].x,b[a].y);p.stroke(),p.closePath()},a.calcS=function(a){return Math.abs((a[1].x-a[0].x)*(a[2].y-a[0].y)-(a[2].x-a[0].x)*(a[1].y-a[0].y))/2},a.dotToSv=function(c){var d=_({x:c.x,y:c.y},this.vol),a=Z(d,this.vol[0]);a<1&&(a=Math.floor(a)),a>this.h-1&&(a=this.h);var e=a/this.h,b=Math.abs(aa(c,this.sSide));return b<30&&(b=30),b-=30,b=60-b,{s:b/=60,v:e}},a.isDotIn=function(c){var a=[{x:this.path[0].x,y:this.path[0].y},{x:this.path[1].x,y:this.path[1].y},{x:c.x,y:c.y}],b=this.calcS(a);return a[1]={x:this.path[2].x,y:this.path[2].y},b+=this.calcS(a),a[0]={x:this.path[1].x,y:this.path[1].y},b+=this.calcS(a),Math.ceil(b)==Math.ceil(this.s)},a.updateSize=function(){this.outerRadius=b.innerRadius-d.paddingX-this.padding,this.size=Math.floor(2*this.outerRadius*Math.sin(Y(60)));var e=Math.sqrt(3)/2*this.size;this.h=Math.sqrt(3)/2*this.size,this.path=new Array,this.path[0]={x:this.outerRadius,y:0},this.path[1]={x:this.path[0].x-e,y:-1*(this.size/2)},this.path[2]={x:this.path[1].x,y:this.size/2},this.path[3]={x:this.path[0].x,y:this.path[0].y};for(var c=0;c<=this.path.length-1;++c)this.path[c].x+=b.pos.x,this.path[c].y+=b.pos.y;if(this.vol=new Array,this.s=this.calcS(this.path),this.sOnTop){var a=$(this.path[0],this.path[2]);this.vol[0]={x:this.path[1].x,y:this.path[1].y},this.vol[1]={x:a.x,y:a.y},this.sSide=this.path[1]}else{var a=$(this.path[0],this.path[1]);this.vol[0]={x:this.path[2].x,y:this.path[2].y},this.vol[1]={x:a.x,y:a.y},this.sSide=this.path[2]}},M.triangle=a,a}function S(a,b,d,c){return"object"!=typeof a&&(a=document.getElementById(a)),!!a&&(c||(c=""),u[c+b]=d,a.addEventListener?a.addEventListener(b,u[c+b]):a.attachEvent("on"+b,u[c+b]),!0)}function T(a,b,c){return"object"!=typeof a&&(a=document.getElementById(a)),!!a&&(c||(c=""),!!u[c+b]&&(a.removeEventListener?a.removeEventListener(b,u[c+b]):a.detachEvent("on"+b,u[c+b]),u[c+b]=null,!0))}function U(b,g,a){var c,d,e,j,k,f,h,i;switch(b&& void 0===g&& void 0===a&&(g=b.s,a=b.v,b=b.h),j=Math.floor(6*b),k=6*b-j,f=a*(1-g),h=a*(1-k*g),i=a*(1-(1-k)*g),j%6){case 0:c=a,d=i,e=f;break;case 1:c=h,d=a,e=f;break;case 2:c=f,d=a,e=i;break;case 3:c=f,d=h,e=a;break;case 4:c=i,d=f,e=a;break;case 5:c=a,d=f,e=h}return{r:Math.floor(255*c),g:Math.floor(255*d),b:Math.floor(255*e)}}function V(a,b,c){a&& void 0===b&& void 0===c&&(b=a.g,c=a.b,a=a.r);var d,g,e=Math.max(a/=255,b/=255,c/=255),h=Math.min(a,b,c),f=e-h;if(g=0==e?0:f/e,e==h)d=0;else{switch(e){case a:d=(b-c)/f+(b<c?6:0);break;case b:d=(c-a)/f+2;break;case c:d=(a-b)/f+4}d/=6}return{h:d,s:g,v:e}}function W(a){var b=parseInt("#"==a.charAt(0)?a.slice(1):a,16);return{r:b>>16,g:b>>8&255,b:255&b}}function X(a){var b=function(b){var a=b.toString(16);return 1===a.length?"0"+a:a};return"#"+b(a.r)+b(a.g)+b(a.b)}function Y(a){return a*(m/180)}function Z(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))}function $(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2}}function _(d,a){var e=(a[0].x-a[1].x)*(a[0].x-a[1].x)+(a[0].y-a[1].y)*(a[0].y-a[1].y),f=(d.x-a[0].x)*(a[1].x-a[0].x)+(d.y-a[0].y)*(a[1].y-a[0].y),c=!0,b=f/e;return b<0&&(b=0,c=!1),b>1&&(b=1,c=!1),{x:a[0].x+b*(a[1].x-a[0].x),y:a[0].y+b*(a[1].y-a[0].y),pt:c}}function aa(c,a,d){a||(a={x:0,y:0});var e=c.x-a.x,f=c.y-a.y,b=180*Math.atan2(f,e)/m;return d&&b<0&&(b=360+b),b}function ab(){i=2+d.paddingX,y=!1,b.imageData=null,j=F/2,b.pos={x:j,y:j},b.outerRadius=j-i,b.innerRadius=b.outerRadius-b.width,d.path=[{x:b.innerRadius-d.paddingX,y:-1*d.height},{x:b.outerRadius+d.paddingX,y:-1*d.height},{x:b.outerRadius+d.paddingX,y:d.height},{x:b.innerRadius-d.paddingX,y:d.height},{x:b.innerRadius-d.paddingX,y:-((d.height+d.lineWeight/2)*1)}];var c=F;r&&(c+=a.width+2*a.padding),"canvas"!=D.tagName.toLowerCase()&&(D.style.width=c+"px",D.style.height=F+"px"),o.width=c,o.height=F,I!=o&&(o.style.width=c+"px",o.style.height=F+"px");for(var e=0;e<=K.length-1;++e)K[e].updateSize();L&&(L.imageData.triangle=null,L.imageData.quad=null,L.updateSize()),h.updateSize(),r&&a.updateSize()}function ac(b){if(!A||v.updateinput&&!(0,v.updateinput)(E,A,b))return;let c=H.toFixed(2),a="rgba("+l.r+", "+l.g+", "+l.b+", "+c+")";if(!b)switch(C){case"mixed":H<1?A.value=a:A.value=G;break;case"hex":A.value=G;break;case"hsla":A.value="hsla("+(360*k.h).toFixed(2)+", "+(100*k.s).toFixed(2)+"%, "+(100*k.v).toFixed(2)+"%, "+c+")";break;default:A.value=a}B&&(k.v<.5?A.style.color="#FFF":A.style.color="#000",A.style.background=a)}function ad(){S(o,"mousedown",function(a){E.mouseDownEvent(a)},"wait_action_"),S(o,"touchstart",function(a){E.mouseDownEvent(a)},"wait_action_"),S(o,"mouseout",function(a){E.mouseOutEvent(a)},"wait_action_"),S(window,"touchmove",function(a){E.touchMoveEvent(a)},"wait_action_"),S(o,"mousemove",function(a){E.mouseMoveRest(a)},"wait_action_")}function ae(){T(o,"mousedown","wait_action_"),T(o,"touchstart","wait_action_"),T(o,"mouseout","wait_action_"),T(window,"touchmove","wait_action_"),T(o,"mousemove","wait_action_")}function af(a){a=a||window.event;var b,c,d=document.body.scrollLeft+document.documentElement.scrollLeft,e=document.body.scrollTop+document.documentElement.scrollTop;"touchend"==a.type?(b=a.changedTouches[0].clientX+d,c=a.changedTouches[0].clientY+e):"touchmove"==a.type||a.touches?(b=a.touches[0].clientX+d,c=a.touches[0].clientY+e):(b=a.clientX+d,c=a.clientY+e);var f=o.getBoundingClientRect();return b-=f.left+d,c-=f.top+e,{x:b,y:c}}function ag(d){for(var c=!1,a=0;a<=K.length-1;++a)K[a].selected&&(c=a),K[a].selected=!1;for(var b=!1,a=0;a<=K.length-1;++a)if(a==d){K[a].selected=!0,E.setColorByHex(K[a].color),b=!0;break}return b&&v.selectcolorsaver&&(0,v.selectcolorsaver)(E,K[d]),b|| !1===c||(K[c].selected=!0),b}function ah(){for(var a=0;a<=K.length-1;++a)K[a].selected&&(K[a].color=G)}function ai(){if(K.length)for(var a=0;a<=K.length-1;++a)K[a].draw()}function aj(){if(!(p&&((p.clearRect(0,0,o.width,o.height),y)?(p.putImageData(z,0,0),ai(),!0):(b.draw(),h.draw(),r&&a.draw(),ai(),L&&L.draw(),s||(z=p.getImageData(0,0,o.width,o.height),y=!0),!0))))return!1;var j=360*k.h-b.startAngle;if(r){p.beginPath();var f=2,i=2,l=a.height*(1-H);p.rect(a.pos.x-i,a.padding+l-f/2,a.width+2*i,f),p.strokeStyle="rgba(0,0,0, 0.8)",p.lineWidth=2,p.stroke(),p.closePath()}p.beginPath();for(var e=function(c,b){b=Y(b);for(var d=new Array,a=0;a<=c.length-1;++a)d[a]={x:c[a].x*Math.cos(b)-c[a].y*Math.sin(b),y:c[a].x*Math.sin(b)+c[a].y*Math.cos(b)};return d}(d.path,j,{x:b.pos.x,y:b.pos.y}),c=0;c<=e.length-1;++c)e[c].x+=b.pos.x,e[c].y+=b.pos.y,0==c?p.moveTo(e[c].x,e[c].y):p.lineTo(e[c].x,e[c].y);return p.strokeStyle="rgba(0,0,0,0.8)",p.lineWidth=d.lineWeight,p.stroke(),p.closePath(),k.v>.5&&k.s<.5?p.strokeStyle="rgba(0, 0, 0, 1)":p.strokeStyle="rgba(255, 255, 255, 1)",p.beginPath(),p.lineWidth=2,p.arc(k.x,k.y,g.radius,0,2*m),p.stroke(),p.closePath(),!1}c.svCursorData=null,c.stCursor=null,c.curType=0,c.size=16,c.cEl=document.body,c.initSvCursor=function(){if(!o)return!1;if(this.curType=1,this.stCursor||(this.stCursor=window.getComputedStyle(this.cEl).cursor,this.stCursor||(this.stCursor="auto")),this.svCursorData)return this.cEl.style.cursor=this.svCursorData,!0;if(!w)return!1;var a=this.size+2;w.width=a,w.height=a,x.clearRect(0,0,this.size,this.size),x.strokeStyle="rgba(255, 255, 255, 1)",x.beginPath(),x.lineWidth=2,x.arc(a/2,a/2,this.size/2,0,2*m),x.stroke(),x.closePath();var b=a,c=w.toDataURL();return this.svCursorData="url("+c+") "+b/2+" "+b/2+", auto",!!this.svCursorData&&(this.cEl.style.cursor=this.svCursorData,-1===this.cEl.style.cursor.indexOf(c)&&(this.svCursorData="crosshair",this.cEl.style.cursor="crosshair"),!0)},c.initStandartCursor=function(){this.stCursor&&(c.curType=0,this.cEl.style.cursor=this.stCursor)},c.updateCursor=function(a){n&&(KellyColorPicker.cursorLock||(h.isDotIn(a)?c.initSvCursor():c.initStandartCursor()))},this.popUpClose=function(a){if(!1!==e.tag){if(a&&(a.target==A||a.target==o||a.target==e.tag))return!1;(!v.popupclose||v.popupclose(E,a))&&(e.tag.style.display="none",KellyColorPicker.activePopUp==E&&(KellyColorPicker.activePopUp=!1))}},this.popUpShow=function(g){if(!1!==e.tag&&(!v.popupshow||v.popupshow(E,g))){KellyColorPicker.popupEventsInclude||(S(document,"click",function(a){return!!KellyColorPicker.activePopUp&&KellyColorPicker.activePopUp.popUpClose(a)},"popup_close_"),S(window,"resize",function(a){if(KellyColorPicker.activePopUp)return KellyColorPicker.activePopUp.popUpShow(a)},"popup_resize_"),KellyColorPicker.popupEventsInclude=!0),KellyColorPicker.activePopUp&&KellyColorPicker.activePopUp.popUpClose(!1);var c=E.getCanvas().width,a=E.getAlphaFig();a&&(c-=a.width+a.padding);var d=window.getComputedStyle(e.tag),b=parseInt(d.paddingBottom)+parseInt(d.paddingTop);b<=0&&(b=0);var f=A.getBoundingClientRect(),h=f.top+(window.scrollY||window.pageYOffset||document.body.scrollTop)-b,i=f.left+(window.scrollX||window.pageXOffset||document.body.scrollLeft);return e.tag.style.top=h-c-e.margin+"px",e.tag.style.left=i+"px",e.tag.style.display="block",KellyColorPicker.activePopUp=E,!1}},this.setHueByDot=function(c){var a=aa(c,b.pos)+b.startAngle;a<0&&(a=360+a),k.h=a/360,l=U(k.h,k.s,k.v),G=X(l),ah(),v.change&&(0,v.change)(E),ac(),y=!1,aj()},this.setColorForColorSaver=function(a,d){var b=P(a,!0);if(b){var c=E.getColorSaver(d);return c.selected?this.setColorByHex(a,!1):(c.color=b.h,aj()),!0}},this.setColor=function(a,b){E.setColorByHex(a,b)},this.setColorByHex=function(a,c){c||(c=!1);var b=H;if(!1!==a){if(!a||!a.length)return;var d=P(a,!0);if(!d)return;a=d.h,r&&(b=d.a)}else a=G;if(r&&a==G&&y&&b!=H){H=b,aj();return}if(!G||a!=G||!y){H=b,l=W(a),G=a,k=V(l);var e=h.svToDot(k);k.x=e.x,k.y=e.y,y=!1,ah(),aj(),v.change&&(0,v.change)(E),ac(c)}},this.setAlphaByDot=function(b){H=a.dotToAlpha(b),v.change&&(0,v.change)(E),ac(),aj()},this.setAlpha=function(a){H=a,ac(),aj()},this.setColorByDot=function(a){var b=h.dotToSv(a);k.s=b.s,k.v=b.v,k.x=a.x,k.y=a.y,k.s>1&&(k.s=1),k.s<0&&(k.s=0),k.v>1&&(k.v=1),k.v<0&&(k.v=0),l=U(k.h,k.s,k.v),G=X(l),ah(),v.change&&(0,v.change)(E),ac(),aj()},this.mouseOutEvent=function(a){c.curType>0&&!KellyColorPicker.cursorLock&&c.initStandartCursor()},this.mouseMoveRest=function(a){if(!s&&t){t=!1;var b=af(a);c.updateCursor(b),requestAnimationFrame(function(){t=!0}),v.mousemoverest&&(0,v.mousemoverest)(a,E,b)}},this.touchMoveEvent=function(a){s&&event.preventDefault()},this.mouseDownEvent=function(g){g.preventDefault();var d,e=!1,c=af(g);if(b.isDotIn(c))s="wheel",E.setHueByDot(c),d=function(a){E.wheelMouseMove(a,c)},e=function(a){KellyColorPicker.cursorLock=!1,E.wheelMouseUp(a,c)};else if(h.isDotIn(c))s="sv",E.setColorByDot(c),d=function(a){E.svMouseMove(a,c)},e=function(a){KellyColorPicker.cursorLock=!1,E.svMouseUp(a,c)};else if(r&&a.isDotIn(c))s="alpha",E.setAlphaByDot(c),d=function(a){E.alphaMouseMove(a,c)},e=function(a){KellyColorPicker.cursorLock=!1,E.alphaMouseUp(a,c)};else if(L&&L.isDotIn(c))E.setMethod();else if(K.length){for(var f=0;f<=K.length-1;++f)if(K[f].isDotIn(c)){ag(f);break}}d&&e&&(ae(),KellyColorPicker.cursorLock=E,S(document,"mouseup",e,"action_process_"),S(document,"mousemove",d,"action_process_"),S(document,"touchend",e,"action_process_"),S(document,"touchmove",d,"action_process_"))},this.wheelMouseMove=function(a,c){if(a.preventDefault(),s&&t){t=!1;var b=af(a);requestAnimationFrame(function(){t=!0}),E.setHueByDot(b),v.mousemoveh&&(0,v.mousemoveh)(a,E,b)}},this.wheelMouseUp=function(a,d){if(a.preventDefault(),s){T(document,"mouseup","action_process_"),T(document,"mousemove","action_process_"),T(document,"touchend","action_process_"),T(document,"touchmove","action_process_"),ad(),s=!1,y=!1,aj();var b=af(a);c.updateCursor(b),v.mouseuph&&(0,v.mouseuph)(a,E,b)}},this.alphaMouseMove=function(c,d){if(c.preventDefault(),s&&t){t=!1;var b=af(c);b=a.limitDotPosition(b),requestAnimationFrame(function(){t=!0}),E.setAlphaByDot(b),v.mousemovealpha&&(0,v.mousemovealpha)(c,E,b)}},this.alphaMouseUp=function(a,d){if(a.preventDefault(),s){T(document,"mouseup","action_process_"),T(document,"mousemove","action_process_"),T(document,"touchend","action_process_"),T(document,"touchmove","action_process_"),ad(),s=!1;var b=af(a);c.updateCursor(b),v.mouseupalpha&&(0,v.mouseupalpha)(a,E,b)}},this.svMouseMove=function(b,c){if(b.preventDefault(),s&&t){t=!1;var a=af(b);a=h.limitDotPosition(a),requestAnimationFrame(function(){t=!0}),E.setColorByDot(a),v.mousemovesv&&(0,v.mousemovesv)(b,E,a)}},this.svMouseUp=function(a,d){if(a.preventDefault(),s){T(document,"mouseup","action_process_"),T(document,"mousemove","action_process_"),T(document,"touchend","action_process_"),T(document,"touchmove","action_process_"),ad(),s=!1;var b=af(a);c.updateCursor(b),r&&(y=!1,aj()),v.mouseupsv&&(0,v.mouseupsv)(a,E,b)}},this.addUserEvent=function(a,b){return v[a]=b,!0},this.removeUserEvent=function(a){return!!v[a]&&(v[a]=null,!0)},this.getCanvas=function(){return!!p&&o},this.getCtx=function(){return!!p&&p},this.getInput=function(){return A},this.getSvFig=function(){return h},this.getSvFigCursor=function(){return g},this.getWheel=function(){return b},this.getWheelCursor=function(){return d},this.getCurColorHsv=function(){return k},this.getCurColorRgb=function(){return l},this.getCurColorHex=function(){return G},this.getCurColorRgba=function(){return{r:l.r,g:l.g,b:l.b,a:H}},this.getCurAlpha=function(){return H},this.getAlphaFig=function(){return!!r&&a},this.getPopup=function(){return e},this.getSize=function(){return F},this.getColorSaver=function(b){for(var a=0;a<=K.length-1;++a)if(!b&&K[a].selected||K[a].align==b)return K[a].rgb=W(K[a].color),K[a].hsv=V(K[a].rgb.r,K[a].rgb.g,K[a].rgb.b),K[a]},this.setColorSaver=function(b){if(!b)return!1;for(var a=0;a<=K.length-1;++a)if(K[a].align==b)return ag(a),K[a]},this.updateView=function(a){return!!p&&(a&&(b.imageData=null,h.imageData=null,z=null),y=!1,ab(),aj(),!0)},this.resize=function(a,c){return!!p&&(a==F&&!c||(y=!1,b.imageData=null,h.imageData=null,z=null,F=a,ab(),E.setColorByHex(!1),!1))},this.syncSize=function(b){if(!I)return!1;var a=O(I);return a&&E.resize(a),!1},this.setMethod=function(a){return a||(a="triangle","triangle"!=q||(a="quad")),a!=q&&("quad"==q||"triangle"==q)&&("quad"==(q=a)&&(h=Q()),"triangle"==q&&(h=R()),E.resize(F,!0),v.setmethod&&(0,v.setmethod)(E,q),!0)},this.destroy=function(){if(!E)return!1;c.curType>0&&(KellyColorPicker.cursorLock=!1,c.initStandartCursor()),s&&(T(document,"mouseup","action_process_"),T(document,"mousemove","action_process_"),T(document,"touchend","action_process_"),T(document,"touchmove","action_process_"),s=!1),e.tag&&T(A,"click","popup_"),A&&(T(A,"click","input_edit_"),T(A,"change","input_edit_"),T(A,"keyup","input_edit_"),T(A,"keypress","input_edit_")),KellyColorPicker.popupEventsInclude&&u.popup_close_click&&(KellyColorPicker.activePopUp&&KellyColorPicker.activePopUp.popUpClose(!1),T(document,"click","popup_close_"),T(window,"resize","popup_resize_"),KellyColorPicker.popupEventsInclude=!1),b.imageData=null,h.imageData=null,z=null,w=null,D&&D.parentNode&&D.parentNode.removeChild(D),I&&T(window,"resize","canvas_"),ae(),E=null},function(a){var c="",f="";(void 0!==a.alpha_slider&&(a.alphaSlider=a.alpha_slider),void 0!==a.input_color&&(a.inputColor=a.input_color),void 0!==a.input_format&&(a.inputFormat=a.input_format),a.input&&"object"!=typeof a.input?(a.input=document.getElementById(a.input),A=a.input):"object"==typeof a.input&&(A=a.input),void 0!==a.changeCursor&&(n=a.changeCursor),void 0!==a.alpha&&(H=a.alpha),void 0!==a.alphaSlider&&(r=a.alphaSlider),void 0!==a.inputColor&&(B=a.inputColor),void 0!==a.inputFormat&&(C=a.inputFormat),a.userEvents&&(v=a.userEvents),a.place&&"object"!=typeof a.place&&(f=a.place,a.place=document.getElementById(a.place)),a.place)?D=a.place:A?(e.tag=document.createElement("div"),e.tag.className="popup-kelly-color",a.popupClass?e.tag.className=a.popupClass:(e.tag.className="popup-kelly-color",e.tag.style.position="absolute",e.tag.style.bottom="0px",e.tag.style.left="0px",e.tag.style.display="none",e.tag.style.backgroundColor="#e1e1e1",e.tag.style.border="1px solid #bfbfbf",e.tag.style.boxShadow="7px 7px 14px -3px rgba(0,0,0,0.24)",e.tag.style.borderTopLeftRadius="4px",e.tag.style.borderTopRightRadius="4px",e.tag.style.borderBottomLeftRadius="4px",e.tag.style.borderBottomRightRadius="4px",e.tag.style.padding="12px",e.tag.style.boxSizing="content-box"),D=e.tag,document.getElementsByTagName("body")[0].appendChild(e.tag),S(A,"click",function(a){return E.popUpShow(a)},"popup_")):c+='| "place" ('+f+") not not found";var b=!1;if(a.color?b=P(a.color):A&&A.value&&(b=P(A.value)),b&&(G=b.h,r&&(H=b.a)),a.method&&("triangle"==a.method||"quad"==a.method)&&(q=a.method),D&&("CANVAS"!=D.tagName?(o=document.createElement("CANVAS"),D.appendChild(o)):o=D,void 0!==window.G_vmlCanvasManager&&(o=window.G_vmlCanvasManager.initElement(o),w=window.G_vmlCanvasManager.initElement(w)),o.getContext&&o.getContext("2d")&&(p=o.getContext("2d"),x=w.getContext("2d"),1))||(c+=" | cant init canvas context"),a.resizeWith&&("object"!=typeof a.resizeWith&&"boolean"!=typeof a.resizeWith&&(a.resizeWith=document.getElementById(a.resizeWith)),I=!0===a.resizeWith?o:a.resizeWith,a.resizeSide&&(J=a.resizeSide),I)&&(O(I)&&(a.size=O(I)),S(window,"resize",function(a){return E.syncSize(a)},"canvas_")),a.size&&a.size>0&&(F=a.size),c){"undefined"!=typeof console&&console.log("KellyColorPicker : "+c);return}if("quad"==q&&(h=Q()),"triangle"==q&&(h=R()),A){var d=function(a){var a=a||window.event;a.target||(a.target=a.srcElement),E.setColorByHex(a.target.value,!0)};S(A,"click",d,"input_edit_"),S(A,"change",d,"input_edit_"),S(A,"keyup",d,"input_edit_"),S(A,"keypress",d,"input_edit_")}a.colorSaver&&(N("left",!0),N("right")),a.methodSwitch&&((L=new Object).size,L.sizePercentage=10,L.position,L.paddingY=4,L.paddingX=4,L.imageData=new Array,L.lineWidth=2,L.color="#c1ebf5",L.updateSize=function(){this.size=parseInt(F-F/100*(100-this.sizePercentage)),this.size<16&&(this.size=16),this.position={x:this.paddingX,y:this.paddingY}},L.draw=function(){if(this.imageData[q]){p.putImageData(this.imageData[q],this.position.x,this.position.y);return}var b,e=W(this.color);w.width=this.size,w.height=this.size,x.clearRect(0,0,this.size,this.size),x.beginPath();var f="triangle";if("triangle"==q&&(f="quad"),x.beginPath(),this.size<35)var d=w.width/2,c=d;else{var d=w.width/2-this.lineWidth;x.arc(this.size/2,this.size/2,d,0,2*m),x.strokeStyle="rgba(0, 0, 0, 0.4)",x.lineWidth=this.lineWidth,x.stroke();var c=d-6;x.closePath(),x.beginPath(),x.arc(this.size/2,this.size/2,c,0,2*m),x.strokeStyle="rgba(0, 0, 0, 0.4)",x.lineWidth=this.lineWidth,x.stroke(),x.closePath()}if(x.beginPath(),"quad"==f){b=Math.floor((2*c-4)/Math.sqrt(2));var g=(this.size-b)/2,a={x:g+b,y:g+b/2};a.y=a.y-b/2,x.moveTo(a.x,a.y),x.lineTo(a.x-b,a.y),x.lineTo(a.x-b,a.y+b),x.lineTo(a.x,a.y+b)}else{b=Math.floor((2*c-4)*Math.sin(Y(60)));var a={x:2*c+(d-c),y:this.size/2},h=Math.sqrt(3)/2*b;x.moveTo(a.x,a.y),x.lineTo(a.x-h,a.y-b/2),x.lineTo(a.x-h,a.y+b/2),x.lineTo(a.x,a.y)}x.lineTo(a.x,a.y),x.fillStyle="rgba("+e.r+","+e.g+","+e.b+", 1)",x.fill(),x.lineWidth=this.lineWidth,x.strokeStyle="rgba(0, 0, 0, 0.6)",x.stroke(),x.closePath(),this.imageData[q]=x.getImageData(0,0,w.width,w.width),p.drawImage(w,this.position.x,this.position.y)},L.isDotIn=function(a){return a.x>=this.position.x&&a.x<=this.position.x+this.size&&a.y>=this.position.y&&a.y<=this.position.y+this.size}),ad(),ab(),E.setColorByHex(!1)}(f)}KellyColorPicker.cursorLock=!1,KellyColorPicker.activePopUp=!1,KellyColorPicker.popupEventsInclude=!1,KellyColorPicker.attachToInputByClass=function(e,a){for(var d=new Array,c=document.getElementsByClassName(e),b=0;b<c.length;b++)a?a.input=c[b]:a={input:c[b],size:150},d.push(new KellyColorPicker(a));return d}