function calcGroupDelay(a,t){if(a.length<2)return[[],[]];t=unwrapPhase(t);for(var e=[],s=[],i=1;i<a.length;i++){var h=2*(a[i]-a[i-1])*Math.PI,r=(a[i-1]+a[i])/2;e.push(r);var l=-1e3*((t[i]-t[i-1])/180*Math.PI)/h;s.push(l)}return[e,s]}function unwrapPhase(a,t=150){var e=0,s=0,i=new Array(a.length).fill(0);if(a.length>0){i[0]=a[0];for(var h=1;h<a.length;h++){var r=a[h-1]+s,l=a[h]-r,n=!1;l>t?(e-=1,n=!0):l<-t&&(e+=1,n=!0),i[h]=a[h]+360*e,n||(s=i[h]-i[h-1])}}return i}class BaseFilter{constructor(){}complexGain(a,t=!1){return[a,new Array(a.length).fill(1)]}gainAndPhase(a,t=!1){var[e,s]=this.complexGain(a,t);return[s.map((a=>20*Math.log10(a.abs()+1e-15))),s.map((a=>180*Math.atan2(a.im,a.re)/Math.PI))]}}class Biquad extends BaseFilter{constructor(a,t){var e,s,i,h,r,l;switch(super(),a.type){case"Free":e=1,s=a.a1,i=a.a2,h=a.b0,r=a.b1,l=a.b2;break;case"Highpass":var n=a.freq,p=a.q,o=2*Math.PI*n/t,f=Math.sin(o),u=Math.cos(o),M=f/(2*p);h=(1+u)/2,r=-(1+u),l=(1+u)/2,e=1+M,s=-2*u,i=1-M;break;case"Lowpass":var m=a.freq,c=a.q,d=2*Math.PI*m/t,g=Math.sin(d),q=Math.cos(d),w=g/(2*c);h=(1-q)/2,r=1-q,l=(1-q)/2,e=1+w,s=-2*q,i=1-w;break;case"Peaking":var v,y=a.freq,b=a.gain,P=2*Math.PI*y/t,I=Math.sin(P),x=Math.cos(P),B=Math.pow(10,b/40);if("q"in a){v=I/(2*a.q)}else{var k=a.bandwidth;v=I*Math.sinh(Math.log(2)/2*k*P/I)}h=1+v*B,r=-2*x,l=1-v*B,e=1+v/B,s=-2*x,i=1-v/B;break;case"HighshelfFO":var F=a.freq,L=a.gain,O=2*Math.PI*F/t,G=Math.pow(10,L/40),_=Math.tan(O/2);h=G*_+Math.pow(G,2),r=G*_-Math.pow(G,2),l=0,e=G*_+1,s=G*_-1,i=0;break;case"Highshelf":var H,A,S=a.freq,C=a.gain,z=2*Math.PI*S/t,E=Math.pow(10,C/40),Q=Math.sin(z),R=Math.cos(z);if("slope"in a){var D=a.slope;H=Q/2*Math.sqrt((E+1/E)*(1/(D/12)-1)+2),A=2*Math.sqrt(E)*H}else{var N=a.q;A=Q*Math.sqrt(E)/N}h=E*(E+1+(E-1)*R+A),r=-2*E*(E-1+(E+1)*R),l=E*(E+1+(E-1)*R-A),e=E+1-(E-1)*R+A,s=2*(E-1-(E+1)*R),i=E+1-(E-1)*R-A;break;case"LowshelfFO":var T=a.freq,U=a.gain,$=2*Math.PI*T/t,j=Math.pow(10,U/40),J=Math.tan($/2);h=Math.pow(j,2)*J+j,r=Math.pow(j,2)*J-j,l=0,e=J+j,s=J-j,i=0;break;case"Lowshelf":var K,V,W=a.freq,X=a.gain,Y=2*Math.PI*W/t,Z=Math.pow(10,X/40),aa=Math.sin(Y),ta=Math.cos(Y);if("slope"in a){var ea=a.slope;K=aa/2*Math.sqrt((Z+1/Z)*(1/(ea/12)-1)+2),V=2*Math.sqrt(Z)*K}else{var sa=a.q;V=aa*Math.sqrt(Z)/sa}h=Z*(Z+1-(Z-1)*ta+V),r=2*Z*(Z-1-(Z+1)*ta),l=Z*(Z+1-(Z-1)*ta-V),e=Z+1+(Z-1)*ta+V,s=-2*(Z-1+(Z+1)*ta),i=Z+1+(Z-1)*ta-V;break;case"LowpassFO":var ia=a.freq,ha=2*Math.PI*ia/t;e=1,s=-(1-(ra=Math.tan(ha/2)))/(qa=1+ra),i=0,h=ra/qa,r=ra/qa,l=0;break;case"HighpassFO":var ra;ia=a.freq,ha=2*Math.PI*ia/t;e=1,s=-(1-(ra=Math.tan(ha/2)))/(qa=1+ra),i=0,h=1/qa,r=-1/qa,l=0;break;case"Notch":ia=a.freq,ha=2*Math.PI*ia/t;var la=Math.sin(ha);h=1,r=-2*(ga=Math.cos(ha)),l=1,e=1+(qa="q"in a?la/(2*a.q):la*Math.sinh(Math.log(2)/2*a.bandwidth*ha/la)),s=-2*ga,i=1-qa;break;case"GeneralNotch":var na=a.freq_pole,pa=a.freq_zero,oa=a.q_pole,fa=!0===a.normalize_at_dc,ua=Math.tan(Math.PI*pa/t),Ma=Math.tan(Math.PI*na/t),ma=Ma**2,ca=ua**2,da=fa?ma/ca:1;h=da*(1+ca),r=-2*da*(1-ca),l=da*(1+ca),e=1+(qa=Ma/oa)+ma,s=2*ma-2,i=1-qa+ma;break;case"Bandpass":ia=a.freq,ha=2*Math.PI*ia/t,la=Math.sin(ha);var ga=Math.cos(ha);h=qa="q"in a?la/(2*a.q):la*Math.sinh(Math.log(2)/2*a.bandwidth*ha/la),r=0,l=-qa,e=1+qa,s=-2*ga,i=1-qa;break;case"Allpass":ia=a.freq,ha=2*Math.PI*ia/t,la=Math.sin(ha),ga=Math.cos(ha);h=1-(qa="q"in a?la/(2*a.q):la*Math.sinh(Math.log(2)/2*a.bandwidth*ha/la)),r=-2*ga,l=1+qa,e=1+qa,s=-2*ga,i=1-qa;break;case"AllpassFO":ia=a.freq,ha=2*Math.PI*ia/t;var qa,wa=Math.tan(ha/2);h=1,r=qa=(wa+1)/(wa-1),l=0,e=qa,s=1,i=0;break;case"LinkwitzTransform":var va=a.freq_act,ya=a.q_act,ba=a.q_target,Pa=a.freq_target,Ia=Math.pow(2*Math.PI*va,2),xa=2*Math.PI*va/ya,Ba=Math.pow(2*Math.PI*Pa,2),ka=2*Math.PI*Pa/ba,Fa=(Pa+va)/2,La=2*Math.PI*Fa/Math.tan(Math.PI*Fa/t),Oa=Ba+La*ka+Math.pow(La,2);h=(Ia+La*xa+Math.pow(La,2))/Oa,r=2*(Ia-Math.pow(La,2))/Oa,l=(Ia-La*xa+Math.pow(La,2))/Oa,e=1,s=2*(Ba-Math.pow(La,2))/Oa,i=(Ba-La*ka+Math.pow(La,2))/Oa}this.fs=t,this.a1=s/e,this.a2=i/e,this.b0=h/e,this.b1=r/e,this.b2=l/e}complexGain(a,t=!1){for(var e,s,i,h,r,l=a.length,n=[],p=0;p<l;p++)h=(i=Complex(0,1).mul(2*Math.PI*a[p]/this.fs).exp()).pow(-1),r=i.pow(-2),s=h.mul(this.b1).add(this.b0).add(r.mul(this.b2)),e=h.mul(this.a1).add(1).add(r.mul(this.a2)),n.push(s.div(e));return[a,n]}}class BiquadCombo extends BaseFilter{ButterwQ(a){for(var t=a%2>0,e=Math.floor(a/2),s=[],i=0;i<e;i++){var h=1/(2*Math.sin(Math.PI/a*(i+.5)));s.push(h)}return t&&s.push(-1),s}constructor(a,t){if(super(),this.ftype=a.type,["LinkwitzRileyHighpass","LinkwitzRileyLowpass","ButterworthHighpass","ButterworthHighpass","ButterworthLowpass"].includes(this.ftype)){var e;if(this.order=a.order,this.freq=a.freq,this.fs=t,"LinkwitzRileyHighpass"===this.ftype){var s=this.ButterwQ(this.order/2);e=this.order/2%2>0?s.slice(0,-1).concat(s).concat([.5]):s.concat(s),this.typeSO="Highpass",this.typeFO="HighpassFO"}else if("LinkwitzRileyLowpass"===this.ftype){s=this.ButterwQ(this.order/2);e=this.order/2%2>0?s.slice(0,-1).concat(s).concat([.5]):s.concat(s),this.typeSO="Lowpass",this.typeFO="LowpassFO"}else"ButterworthHighpass"===this.ftype?(e=this.ButterwQ(this.order),this.typeSO="Highpass",this.typeFO="HighpassFO"):"ButterworthLowpass"===this.ftype&&(e=this.ButterwQ(this.order),this.typeSO="Lowpass",this.typeFO="LowpassFO");this.biquads=e.map((a=>new Biquad(a>=0?{freq:this.freq,q:a,type:this.typeSO}:{freq:this.freq,type:this.typeFO},this.fs)))}else if("FivePointPeq"===this.ftype)this.biquads=[new Biquad({freq:a.fls,q:a.qls,gain:a.gls,type:"Lowshelf"},t),new Biquad({freq:a.fp1,q:a.qp1,gain:a.gp1,type:"Peaking"},t),new Biquad({freq:a.fp2,q:a.qp2,gain:a.gp2,type:"Peaking"},t),new Biquad({freq:a.fp3,q:a.qp3,gain:a.gp3,type:"Peaking"},t),new Biquad({freq:a.fhs,q:a.qhs,gain:a.ghs,type:"Highshelf"},t)];else if("GraphicEqualizer"===this.ftype){var i=a.gains.length,h=a.freq_min||20,r=a.freq_max||2e4,l=Math.log2(h),n=(Math.log2(r)-l)/i;this.biquads=a.gains.map(((a,e)=>{if(Math.abs(a)>.01){var s=l+(e+.5)*n,i=Math.pow(2,s);return new Biquad({freq:i,bandwidth:n,gain:a,type:"Peaking"},t)}})).filter((a=>a))}else if("Tilt"===this.ftype){var p=-a.gain/2,o=a.gain/2;this.biquads=[new Biquad({freq:110,q:.35,gain:p,type:"Lowshelf"},t),new Biquad({freq:3500,q:.35,gain:o,type:"Highshelf"},t)]}}complexGain(a,t=!1){var e=new Array(a.length).fill(1);return this.biquads.forEach((t=>{var[s,i]=t.complexGain(a);e=e.map(((a,t)=>a*i[t]))})),[a,e]}}class Conv{constructor(a,t){a||(a={values:[1]}),a.filename?this.impulse=read_coeffs(a):this.impulse=a.values,this.fs=t}findPeak(){for(var a=Math.abs(this.impulse[0]),t=0,e=1;e<this.impulse.length;e++){var s=Math.abs(this.impulse[e]);s>a&&(a=s,t=e)}return t}complexGain(a,t=!1){var e=this.impulse.length,s=Math.pow(2,Math.ceil(Math.log2(e)));s<1024&&(s=1024);var i=this.impulse.slice(),h=new Array(s-e).fill(0);i=i.concat(h);var r=fft(i),l=Array.from({length:s/2},((a,t)=>this.fs*t/s)),n=r.slice(0,s/2);if(t){var p=this.findPeak();n=n.map(((a,t)=>{Complex(0,1).neg().mul(Math.PI*t*p/(s/2)).exp().mul(a)}))}return null!==a?[a,this.interpolatePolar(n,l,a)]:[l,n]}interpolate(a,t,e){var s=[];for(var i of e){var h=a.length*i/t[t.length-1],r=Math.floor(h),l=r+1;r>=a.length&&(r=a.length-1),l>=a.length&&(l=r);var n=h-r,p=(1-n)*a[r]+n*a[l];s.push(p)}return s}interpolatePolar(a,t,e){var s=a.map((a=>a.abs())),i=a.map((a=>180*Math.atan2(a.im,a.re)/Math.PI));i=this.unwrapPhase(i,270).map((a=>Math.PI*a/180));var h=this.interpolate(s,t,e),r=this.interpolate(i,t,e);return h.map(((a,t)=>Complex({r:a,phi:r[t]})))}gainAndPhase(a,t=!1){var[e,s]=this.complexGain(null,t),i=this.interpolatePolar(s,e,a);return[i.map((a=>20*Math.log10(a.abs()+1e-15))),i.map((a=>180*Math.atan2(a.im,a.re)/Math.PI))]}getImpulse(){return[Array.from({length:this.impulse.length},((a,t)=>t/this.fs)),this.impulse]}}class Delay extends BaseFilter{constructor(a,t){super(),this.fs=t;var e=a.unit||"ms";if(null===e&&(e="ms"),"ms"===e)this.delaySamples=a.delay/1e3*t;else if("mm"===e)this.delaySamples=a.delay/1e3*t/343;else{if("samples"!==e)throw new Error(`Unknown unit ${e}`);this.delaySamples=a.delay}this.subsample=!0===a.subsample,this.subsample?(this.delayFullSamples=Math.floor(this.delaySamples),this.fraction=this.delaySamples-this.delayFullSamples,this.a1=1-this.fraction,this.a2=0,this.b0=1-this.fraction,this.b1=1,this.b2=0):this.delayFullSamples=Math.round(this.delaySamples)}complexGain(a,t=!1){var e,s,h,r,l,n=a.map((a=>{Complex(0,1).mul(2*Math.PI*a/this.fs).exp()}));this.subsample?e=n.map((t=>{t=Complex(0,1).mul(2*Math.PI*a[i]/this.fs).exp(),r=t.pow(-1),l=t.pow(-2),h=r.mul(this.b1).add(this.b0).add(l.mul(this.b2)),s=r.mul(this.a1).add(1).add(l.mul(this.a2)),h.div(s)})):e=new Array(n.length).fill(1);if(!t){var p=this.delayFullSamples/this.fs;e=e.map(((t,e)=>{Complex(0,1).mul(2*Math.PI*a[e]*p).exp().mul(t)}))}return[a,e]}}class DiffEq extends BaseFilter{constructor(a,t){super(),this.fs=t,this.a=a.a,this.b=a.b,0===this.a.length&&(this.a=[1]),0===this.b.length&&(this.b=[1])}complex_gain(a,t=!1){var e=a.map((a=>{Complex(0,1).mul(2*Math.PI*a/this.fs).exp()})),s=new Array(a.length).fill(0);this.b.forEach(((a,t)=>{s=s.map(((s,i)=>{e[i].pow(-t).mul(a).add(s)}))}));var i=new Array(a.length).fill(0);return this.a.forEach(((a,t)=>{i=i.map(((s,i)=>{e[i].pow(-t).mul(a).add(s)}))})),[a,s.map(((a,t)=>a.div(i[t])))]}}class Gain extends BaseFilter{constructor(a){super(),this.gain=a.gain,this.inverted=!0===a.inverted,this.scale=a.scale||"dB"}complexGain(a,t=!1){var e,s=this.inverted?-1:1;return e="dB"===this.scale?Math.pow(10,this.gain/20)*s:this.gain*s,[a,new Array(a.length).fill(e)]}}class Loudness extends BaseFilter{constructor(a,t,e){super();var s=-(e-a.reference_level)/20,i=(s=Math.max(0,Math.min(1,s)))*a.high_boost,h=s*a.low_boost;if(a.attenuate_mid){var r=Math.max(i,h);this.midGain=Math.pow(10,-r/20)}else this.midGain=1;var l=new Biquad({freq:70,slope:12,gain:h,type:"Lowshelf"},t),n=new Biquad({freq:3500,slope:12,gain:i,type:"Highshelf"},t);this.biquads=[l,n]}complexGain(a,t=!1){var e=new Array(a.length).fill(this.midGain);return this.biquads.forEach((t=>{var[s,i]=t.complexGain(a);e=e.map(((a,t)=>a*i[t]))})),[a,e]}}
